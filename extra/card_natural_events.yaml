type: entities # Card Principale Entità
style: |
  ha-card {
      border: 1px solid {% if is_state('group.natural_events', 'on') %} {{states('sensor.natural_events_level')}} {% else %} Green {% endif %};
  }
  .card-content {
    padding: 0;
  }
  .card-content > div {
    margin: 0 !important;
  }
entities:
  - type: custom:hui-element #custom:hui-markdown-card # TESTATINA PRINCIPALE
    card_type: markdown
    style: |
      @keyframes blink {
        30% {
          background: {% if is_state('group.natural_events', 'on') %} gray {% endif %};
        }
      }
      ha-card {
        animation: {% if is_state('group.natural_events', 'on') %} blink 2s linear 3 {% endif %};
        border-radius: var(--ha-card-border-radius) var(--ha-card-border-radius) 0px 0px;
        border-style: solid;
        box-shadow: none;
        {% if is_state('group.natural_events', 'on') %}
        background: {{states('sensor.natural_events_level')}};
        border-color: {{states('sensor.natural_events_level')}};
        color: {% if states('sensor.natural_events_level') in ['White','Yellow'] %} red; {% else %} yellow; {% endif %}
        {% else %}
        background: Green;
        border-color: Green;
        {% endif %}
        }
      }
    content: >-
      ## <center>
      {% if is_state('group.natural_events', 'on') %} 
      <ha-icon icon="mdi:alert" style="width: 48px; height: 48px;"></ha-icon> &nbsp; ALLERTA EVENTI CRITICI
      {% else %} 
      <ha-icon icon="mdi:shield-check" style="width: 48px; height: 48px;"></ha-icon> &nbsp; NESSUN EVENTO CRITICO

      {% set summary = states('sensor.dark_sky_daily_summary') %}
      <center>{{'' if summary  == 'unknown' else summary }}
      {% endif %}

  - type: custom:hui-element # MENU Impostazioni fold, SENSORI on
    card_type: entities
    style: |
      ha-card {
        background:none; border-radius: 0px; box-shadow: none; 
      }
      div#states.card-content {padding-block-end: 0;padding-block-start: 0;}
    entities:
      - type: custom:auto-entities # MENU Impostazioni fold
        show_empty: false
        filter:
          include:
            - attributes:
                package: Natural_events
          exclude:
            - domain: binary_sensor
            - domain: group
            - domain: sensor
            - domain: script
            - domain: zone
        card:
          type: custom:fold-entity-row
          style: |
            :host {
              color: {% if is_state(config.entity, 'on') %} yellow {% endif %};
            }
          head: input_boolean.natural_events

      - type: custom:fold-entity-row
        head: group.meteoalert
      - type: custom:fold-entity-row
        head: group.geoalert

      - type: custom:auto-entities # SENSORI on
        filter:
          include:
            - domain: binary_sensor
              state: 'on'
              attributes:
                  package: Natural_events
              options:
                secondary_info: last-changed
                style: |
                  :host {
                    {% set color = {0:'White', 1:'Green', 2:'Yellow', 3:'Orange', 4:'Red'} %}
                    color: {% if 'dpc' in config.entity %} {{color[state_attr(config.entity, 'level')|int]}} 
                            {% elif 'meteoalarm' in config.entity %} {{states('sensor.meteoalarm_level')}}
                            {% elif 'quake' in config.entity %} {{color[state_attr('binary_sensor.lastquake', 'level')|int]}}
                           {% endif %};
                  }
        card:
          type: entities
          show_empty: false
          style: |
            ha-card {background: none; border-radius: 0px; box-shadow: none;}
            .card-content {padding: 0}

  - type: custom:hui-element # NSCONDE/VISUALIZZA tutte le cards
    card_type: conditional
    conditions:
      - entity: input_boolean.natural_events
        state: 'on'
    card:
      type: entities
      style: |
        ha-card {border-radius: 0px; box-shadow: none; background: none;}
        div#states.card-content {padding: 0;}

      # CARDS VISUALIZZATE SOLO SE INPUT BOOLEAN NATURAL EVENTS ON!!
      entities:
        - type: custom:auto-entities # TERREMOTO conditional
          show_empty: false
          filter:
            include:
              - entity_id: binary_sensor.lastquake
                state: 'on'
          card:
            type: custom:text-divider-row # TEREMOTO divider
            text:  TERREMOTO

        - type: custom:auto-entities # TERREMOTO markdown
          show_empty: false
          filter:
            include:
              - entity_id: binary_sensor.lastquake
                state: 'on'
          card:
            type: markdown
            style: >
              ha-card {background: none; border-radius: 0px; box-shadow: none; color: gray;}
              .card-content {padding: 0}
            content: >-
              {% set device_tracker = 'device_tracker.oneplus_5t' %}
              {% set data_utc = state_attr('binary_sensor.lastquake', 'publication_date') %}
              {% set magnitudo = (state_attr('binary_sensor.lastquake', 'magnitude')|float) if not none else '0' %}
              {% set code = {0:'White', 1:'Green', 2:'Yellow', 3:'Orange', 4:'Red'} %}
              {% set color = code[state_attr('binary_sensor.lastquake', 'level')|int] %}
              {% set lat = state_attr('binary_sensor.lastquake', 'lat') %}
              {% set lon = state_attr('binary_sensor.lastquake', 'long') %}
              <font color={{color}}>{{as_timestamp(data_utc)|timestamp_custom ('%H:%M:%S del %d-%m-%Y')}}</font>


              Un terremoto di magnitudo <font color={{color}}> {{magnitudo}} </font> 
              è avvenuto nella zona: [{{state_attr('binary_sensor.lastquake', 'region')}}](https://www.google.com/maps/search/?api=1&query={{state_attr('binary_sensor.lastquake', 'lat')}},{{state_attr('binary_sensor.lastquake', 'long')}})
              a <font color={{color}}> {{state_attr('binary_sensor.lastquake', 'distance')}} </font> km da casa,
              con coordinate geografiche (lat, lon) {{lat}}, {{lon}}. 
              
              Tu ti trovi a {{distance(lat, lon, device_tracker) | round(1) if (lat and lon) else none}} km dall'epicentro.


              {% if magnitudo >= 3|int %}
              [Shakemap]({{state_attr('binary_sensor.lastquake', 'image_url')}}) ~ 
              [PGA](http://shakemap.rm.ingv.it/shake/{{state_attr('binary_sensor.lastquake', 'short_id')}}/download/pga.jpg) ~ 
              [PGV](http://shakemap.rm.ingv.it/shake/{{state_attr('binary_sensor.lastquake', 'short_id')}}/download/pgv.jpg) ~ 
              [TvMap](http://shakemap.rm.ingv.it/shake/{{state_attr('binary_sensor.lastquake', 'short_id')}}/download/tvmap.jpg) ~ 
              [TvMap2](http://shakemap.rm.ingv.it/shake/{{state_attr('binary_sensor.lastquake', 'short_id')}}/download/tvmap_bare.jpg) ~ 
              [HaiSentitoIlTerremoto](http://eventi.haisentitoilterremoto.it/{{state_attr('binary_sensor.lastquake', 'short_id')}}/{{state_attr('binary_sensor.lastquake', 'short_id')}}_mcs.jpg)


              <img style="border: 2px solid {{color}};" src="{{state_attr('binary_sensor.lastquake', 'image_url')}}"/>
              {% endif %}


              [INGV](http://terremoti.ingv.it/) ~ [HaiSentitoIlTerremoto Web](http://www.haisentitoilterremoto.it/)

        - type: custom:hui-element # TERREMOTO geolocation
          card_type: conditional
          conditions:
            - entity: binary_sensor.lastquake
              state: 'on'
          card:
              type: conditional
              conditions:
                - entity: input_select.meteo_iframe
                  state: 'Posizione Geografica'
              card:
                type: map
                style: |
                  ha-card {
                    border-radius: 0px;
                    border: solid 1px var(--accent-color); 
                    box-shadow: none;
                    margin: 16px;
                  }
                entities:
                  - zone.geoalert
                geo_location_sources:
                  - ingv_centro_nazionale_terremoti
                dark_mode: true
                default_zoom: 10
                aspect_ratio: 100%

        - type: custom:auto-entities # DPC conditional
          show_empty: false
          filter:
            include:
              - entity_id: "*binary_sensor.dpc_*"
                state: 'on'
          card:
            type: custom:text-divider-row # DPC divider
            text: PROTEZIONE CIVILE

        - type: custom:auto-entities # DPC markdown
          show_empty: false
          filter:
            include:
              - entity_id: "*binary_sensor.dpc_*"
                state: "on"
                attributes:
                    level: "> 0"
          card:
            type: markdown
            style: |
              ha-card {background: none; border-radius: 0px; box-shadow: none;}
              .card-content {padding: 0}
            content: >
              {% set color = {0:'White', 1:'Green', 2:'Yellow', 3:'Orange', 4:'Red'} %}
              {% for e in config.entities %}


              <font color= {{color[state_attr(e.entity, 'level')|int]}}>
              <ha-icon icon="{{ 'mdi:numeric-' ~ state_attr(e.entity, 'level')|int ~ '-box'}}" style="width: 36px; height: 36px;"></ha-icon> 
              {{state_attr(e.entity, 'friendly_name')}} - {{state_attr(e.entity, 'allerta')}} {{state_attr(e.entity, 'info')}}</font>
              {%- endfor %}


              [Protezione Civile](http://www.protezionecivile.it/home) ~ [Vigilanza Meteo](http://www.protezionecivile.gov.it/dettaglio/-/journal_content/56/20182/1131180?refererPlid=42041&controlPanelCategory=current_site.content)
              ~ [Criticità Idro](http://www.protezionecivile.gov.it/attivita-rischi/meteo-idro/attivita/previsione-prevenzione/centro-funzionale-centrale-rischio-meteo-idrogeologico/previsionale/bollettini-criticita/bollettino-odierno) ~ [Radar](http://www.protezionecivile.gov.it/radar-dpc)

        - type: custom:auto-entities # BURZE conditional
          show_empty: false
          filter:
            include:
              - entity_id: binary_sensor.burze_storms_nearby
                state: 'on'
          card:
            type: entities
            style: |
              ha-card {background: none; border-radius: 0px; box-shadow: none;}
              .card-content {padding: 0;}
            show_header_toggle: false
            entities:
              - type: custom:text-divider-row
                text: BURZE

              - type: custom:auto-entities # BURZE markdown
                show_empty: false
                filter:
                  include:
                    - entity_id: binary_sensor.burze_storms_nearby
                      state: 'on'
                card:
                  type: markdown
                  style: |
                    ha-card {background: none; border-radius: 0px; box-shadow: none;}
                  content: >-
                    <font color= #4caf50>{{state_attr('binary_sensor.burze_storms_nearby', 'number')}}</font><font color= yellow><ha-icon icon="mdi:flash" style="width: 24px; height: 24px; transform: rotate(35deg);"></ha-icon></font> in <font color= #4caf50> {{state_attr('binary_sensor.burze_storms_nearby', 'period')}}</font> minuti.
                    Il più vicino è caduto a <font color= #4caf50> {{state_attr('binary_sensor.burze_storms_nearby', 'distance')}} Km </font> a <font color= #4caf50> {{states('sensor.burze_direction')}} </font>
                    </font> da casa.


                    [Burze](https://burze.dzis.net) ~ [Blitzortung](http://map.blitzortung.org/#5.11/43.00/13.00) 


        # - type: custom:auto-entities # DARKSKY divider
        #   show_empty: false
        #   filter:
        #     include:
        #       - entity_id: sensor.dark_sky_alerts
        #         state: '> 0'
        #   card:
        #     type: custom:text-divider-row
        #     text: ALLERTA METEO DARKSKY

        - type: custom:auto-entities # METEOALARM divider
          show_empty: false
          filter:
            include:
              - entity_id: binary_sensor.meteoalarm
                state: 'on'
              - entity_id: sensor.dark_sky_alerts
                state: '> 0'
          card:
            type: custom:text-divider-row
            text: METEO ALARM

        - type: custom:auto-entities # DARKSKY ALERTS markdown conditional
          show_empty: false
          filter:
            include:
              - entity_id: sensor.dark_sky_alerts
                state: '> 0'
          card:
            type: markdown
            style: |
              ha-card {background: none; border-radius: 0px; box-shadow: none;}
            content: >
              {%set gg =['dom','lun','mar','mer','gio','ven','sab']%}
              {%set color = {'Green':'Verde', 'Yellow':'Gialla', 'Orange':'Arancione', 'Red':'Rossa'} %}
              {%set dict_code={'Green':'1','Yellow':'2','Orange':'3','Red':'4'}%}
              {%set dict_type={'No Warnings': 'Nessun Avviso','Wind': 'Vento',
              'Snow-Ice': 'Neve-Ghiaccio','Thunderstorm': 'Temporali',
              'Fog': 'Nebbia','Extreme High Temperatures': 'Temperature massime estreme',
              'Extreme Low Temperatures': 'Temperature minime estreme',
              'Costal Event': 'Eventi Costieri','Forest Fire': 'Incendi bischivi',
              'Avalanche': 'Valanghe','Rain': 'Pioggia',
              'Unavailable': 'Non disponibile','Flooding': 'Alluvione',
              'Rain-Flooding': 'Pioggia-Alluvione'}%}
              {%set item_num=states('sensor.dark_sky_alerts')|int%}
              {%for n in range(0,item_num)-%}
              {% if item_num > 1%}{%set x = '_'~n %}{%else%}{%set x = '' %}{%endif%}
              {%set severity= state_attr('sensor.dark_sky_alerts','title'~x).split(' ')[0]-%}
              {%set event = state_attr('sensor.dark_sky_alerts','title'~x).split(' ')[1:-1]|join(' ')-%}
              {%set gt = state_attr('sensor.dark_sky_alerts','time'~x)|timestamp_custom("%w")|int%}
              {%set ge = state_attr('sensor.dark_sky_alerts','expires'~x)|timestamp_custom("%w")|int%}

              <font color= {{severity}}> <ha-icon icon="{{'mdi:numeric-'~dict_code[severity]~'-box' if severity in dict_code else 'mdi:numeric-0-box'-}}" ></ha-icon> </font>
              <font color= {{severity}}> {{dict_type[event]}}</font>
              da {{gg[gt]|capitalize}} {{state_attr('sensor.dark_sky_alerts','time'~x)|timestamp_custom(" ore %H:%M")}} a {{gg[ge]|capitalize}} {{state_attr('sensor.dark_sky_alerts','expires'~x)|timestamp_custom(" ore %H:%M")}}
              {%-endfor%}

              ___

        - type: custom:auto-entities # METEOALARM markdown conditional
          show_empty: false
          filter:
            include:
              - entity_id: binary_sensor.meteoalarm
                state: 'on'
          card:
            type: markdown
            style: |
              ha-card {background: none; border-radius: 0px; box-shadow: none;}
            content: >
              ## <font color= {{states('sensor.meteoalarm_level')}}> <ha-icon icon="{{state_attr('sensor.meteoalarm_level', 'icon')}}" style="width: 36px; height: 36px;"></ha-icon> </font>
              <font color= {{states('sensor.meteoalarm_level')}}> <ha-icon icon="{{state_attr('sensor.meteoalarm_type', 'icon')}}" style="width: 36px; height: 36px;"></ha-icon></font>
              <font color= {{states('sensor.meteoalarm_level')}}> {{state_attr('binary_sensor.meteoalarm', 'event')}}
              </font><font color= grey> {{state_attr('binary_sensor.meteoalarm', 'urgency')}} </font>
              
              {% set start = state_attr('binary_sensor.meteoalarm', 'effective') %}
              {% set end = state_attr('binary_sensor.meteoalarm', 'expires') %}
              <font> {{as_timestamp(start)|timestamp_custom ('Dal **%d/%m** ore **%H:%M** ')}}
              {{as_timestamp(end)|timestamp_custom ('al **%d/%m** ore **%H:%M**')}}</font>


              **Titolo**

              <font color= grey> {{state_attr('binary_sensor.meteoalarm', 'headline')}} </font>


              **Descrizione**

              <font color= grey> {{state_attr('binary_sensor.meteoalarm', 'description')}} </font>


              **Istruzioni**

              <font color= grey> {{state_attr('binary_sensor.meteoalarm', 'instruction')}} </font>


              [MeteoAlarm]({{state_attr('binary_sensor.meteoalarm', 'web')}}) 


        - type: custom:auto-entities # CUSTOM COMPONENT meteoalarm_m conditional
          show_empty: false
          filter:
            include:
              - entity_id: sensor.alert
                state: '> 0'
          card:
            type: custom:flex-table-card
            # title: today
            entities:
              include: sensor.alert
            columns:
              - attr_as_list: today
                modify: x.code.concat(' ', x.event)
                name: Oggi
              - attr_as_list: today
                modify: x.italiano
                name: ''
              - attr_as_list: today
                modify: x.end
                name: ''

        - type: custom:auto-entities # CUSTOM COMPONENT meteoalarm_m conditional
          show_empty: false
          filter:
            include:
              - entity_id: sensor.alert
                state: '> 0'
          card:
            type: custom:flex-table-card
            # title: tomorrow
            entities:
              include: sensor.alert
            columns:
              - attr_as_list: tomorrow
                modify: x.code.concat(' ', x.event)
                name: Domani
              - attr_as_list: tomorrow
                modify: x.italiano
                name: ''
              - attr_as_list: tomorrow
                modify: x.end
                name: ''

        - type: custom:hui-element # MAPPA Giorno/Notte
          card_type: conditional
          conditions:
            - entity: group.natural_events
              state: 'off'
          card:
              type: picture-entity
              style: |
                ha-card {
                  border-radius: 0px; 
                  border: solid 1px var(--accent-color);
                  box-shadow: none;
                  margin: 16px;
                }
              entity: sun.sun
              state_image:
                "above_horizon": https://api.sat24.com/animated/IT/visual/3/Central%20European%20Standard%20Time/3065655' width=845 height=615
                "below_horizon": https://api.sat24.com/animated/IT/infraPolair/3/Central%20European%20Standard%20Time/2523464' width=845 height=615

        - type: custom:hui-element # MAPPE meteo
          card_type: conditional
          conditions:
            - entity: group.meteoalert
              state: 'on'
            - entity: input_select.meteo_map
              state_not: 'Nessuna'
          card:
            type: picture-entity
            style: |
              ha-card {
                border-radius: 0px; 
                border: solid 1px var(--accent-color);
                box-shadow: none;
                margin: 16px;
              }
            title: Nuvole
            entity: input_select.meteo_map
            tap_action:
              action: call-service
              service: input_select.select_next
              service_data:
                entity_id: input_select.meteo_map
            hold_action:
              action: call-service
              service: input_select.select_previous
              service_data:
                entity_id: input_select.meteo_map
            state_image:
              "Nuvole e Sole": https://api.sat24.com/animated/IT/visual/3/Central%20European%20Standard%20Time/3065655' width=845 height=615
              "Nuvole Infrared": https://api.sat24.com/animated/IT/infraPolair/3/Central%20European%20Standard%20Time/2523464' width=845 height=615
              "Pioggia": https://api.sat24.com/animated/IT/rainTMC/3/Central%20European%20Standard%20Time/3872070' width=845 height=615
              "Neve": https://api.sat24.com/animated/EU/snow/3/Central%20European%20Standard%20Time/4614822' width=845 height=615 
              "Burze": https://burze.dzis.net/italia_fulmine_lebhaft_gruppi_ne.gif
              "WWLLN": https://wwlln.net/WWLLN_movies/Movie_of_Lightning_in_EurAfrica_BIG.gif
            entities: 
              - entity: input_select.meteo_map

        - type: custom:hui-element # IFRAME wwlln
          card_type: conditional
          conditions:
            - entity: binary_sensor.burze_storms_nearby
              state: 'on'
          card:
              type: conditional
              conditions:
                - entity: input_select.meteo_iframe
                  state: 'Posizione Geografica'
              card:
                type: map
                style: |
                  ha-card {
                    border-radius: 0px;
                    border: solid 1px var(--accent-color); 
                    box-shadow: none;
                    margin: 16px;
                  }
                entities:
                  - zone.meteoalert
                geo_location_sources:
                  - wwlln
                dark_mode: true
                default_zoom: 8
                aspect_ratio: 100%

        - type: custom:hui-element # IFRAME windy
          card_type: conditional
          conditions:
            - entity: group.meteoalert
              state: 'on'
          card:
              type: conditional
              conditions:
                - entity: input_select.meteo_iframe
                  state: 'Windy Alert'
              card:
                type: iframe
                style: |
                  ha-card {
                    border-radius: 0px;
                    border: solid 1px var(--accent-color); 
                    box-shadow: none;
                    margin: 16px;
                  }
                aspect_ratio: 100%
                url: https://embed.windy.com/embed2.html?lat=42.000&lon=12.000&zoom=5&level=surface&overlay=capAlerts&menu=&type=map&location=coordinates&detail=&detailLat=42.000&detailLon=12.000
